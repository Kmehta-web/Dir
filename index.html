<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Secure Text Submission</title>
    <script src="https://cdn.jsdelivr.net/npm/jwt-decode"></script>
    <!-- Firebase SDK v8 -->
    <script src="https://www.gstatic.com/firebasejs/8.0.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.0.0/firebase-auth.js"></script>

    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        table, th, td {
            border: 1px solid black;
        }
        th, td {
            padding: 10px;
            text-align: left;
        }
        .red-background {
            background-color: red;
            color: white;
        }
        #submissionSection {
            display: none; /* Hidden until user logs in */
        }
    </style>
</head>
<body>

    <h1>Secure Text Submission</h1>

    <!-- Google Sign-In Button -->
    <button id="loginBtn" onclick="googleLogin()">Login with Google</button>
    <button id="logoutBtn" onclick="signOut()" style="display:none;">Sign Out</button>
    <p id="user-info"></p>

    <!-- Submission Section (Hidden initially) -->
    <div id="submissionSection">
        <form id="submissionForm">
            <input type="text" id="textInput" placeholder="Enter your text" required>
            <button type="submit">Submit</button>
        </form>

        <table id="submissionTable">
            <thead>
                <tr>
                    <th>Text</th>
                    <th>Date/Time</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDutDyTo8sbmI8ftpIp3K5DtkgmV5uJYPw",
            authDomain: "grcs-69b66.firebaseapp.com",
            projectId: "grcs-69b66",
            storageBucket: "grcs-69b66.appspot.com",
            messagingSenderId: "621698190294",
            appId: "1:621698190294:web:a4e08432305b59ae75b277",
            measurementId: "G-NQ91XL5NMJ"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        let user = null;

        // Google Sign-In
        function googleLogin() {
            const provider = new firebase.auth.GoogleAuthProvider();
            auth.signInWithPopup(provider)
                .then(result => {
                    user = result.user;
                    updateUI(true);
                })
                .catch(error => {
                    console.error("Login Failed", error);
                    alert("Google Sign-In failed. Please try again.");
                });
        }

        // Sign Out
        function signOut() {
            auth.signOut().then(() => {
                user = null;
                updateUI(false);
            });
        }

        // Update UI Based on Auth State
        function updateUI(isLoggedIn) {
            if (isLoggedIn) {
                document.getElementById("user-info").innerText = `Logged in as: ${user.displayName}`;
                document.getElementById("loginBtn").style.display = "none";
                document.getElementById("logoutBtn").style.display = "block";
                document.getElementById("submissionSection").style.display = "block";
            } else {
                document.getElementById("user-info").innerText = "";
                document.getElementById("loginBtn").style.display = "block";
                document.getElementById("logoutBtn").style.display = "none";
                document.getElementById("submissionSection").style.display = "none";
            }
        }

        // Listen for Auth State Changes
        auth.onAuthStateChanged((currentUser) => {
            user = currentUser;
            updateUI(!!user);
        });

        // Form Submission
        document.getElementById('submissionForm').addEventListener('submit', function(event) {
            event.preventDefault();
            let textInput = document.getElementById('textInput').value;
            if (!user) {
                alert('Please login using Google first!');
                return;
            }

            let currentDateTime = new Date().toLocaleString();
            let isJWT = false;

            // Verify if the input is a JWT token
            try {
                let decodedToken = jwt_decode(textInput);
                if (decodedToken && decodedToken.header.alg === 'ES256') {
                    isJWT = true;
                }
            } catch (e) {
                console.log("Not a valid JWT");
            }

            // Add row to the table
            let row = document.createElement('tr');
            if (isJWT) row.classList.add('red-background');
            row.innerHTML = `<td>${textInput}</td><td>${currentDateTime}</td>`;
            document.querySelector('#submissionTable tbody').appendChild(row);

            document.getElementById('textInput').value = ''; // Clear input
        });
    </script>

</body>
</html>
